<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parte Diario de Fibra √ìptica</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10mm 5mm;
      background: #f5f7fa;
      color: #333;
    }
    .header, .section {
      background: #ffffff;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 25px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.08);
      border: 2px solid #1565c0;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }
    .logo {
      max-height: 80px;
    }
    .section h2 {
      display: flex;
      align-items: center;
      font-size: 18px;
      color: #0d47a1;
      border-bottom: 2px solid #0d47a1;
      padding-bottom: 6px;
      margin-bottom: 14px;
    }
    .section h2 .fa {
      margin-right: 8px;
    }
    .field {
      display: flex;
      align-items: center;
      margin: 10px 0;
      flex-wrap: wrap;
    }
    .field i {
      width: 25px;
      text-align: center;
      color: #0d47a1;
    }
    .field label {
      flex: 0 0 180px;
      font-weight: bold;
      color: #333;
    }
    .field input,
    .field select,
    .field textarea {
      flex: 1;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      background-color: #fdfdfd;
    }
    .header .field input {
      font-size: 13px;
      padding: 4px 8px;
    }
    #map {
      height: 300px;
      border-radius: 6px;
      margin-top: 10px;
      border: 1px solid #ddd;
      max-width: 100%;
      overflow: hidden;
    }
    .images-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      page-break-inside: avoid;
      break-inside: avoid;
    }
    .images-grid img {
      width: 100%;
      height: 67.5mm;
      object-fit: cover;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .pdf-btn {
      padding: 10px 20px;
      background-color: #1565c0;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 10px 0 0;
    }
    .mensaje-ok {
      margin-top: 10px;
      color: green;
      font-weight: bold;
    }
    .pdf-help {
      font-size: 0.95rem;
      color: #444;
      margin-top: 10px;
      line-height: 1.4;
      background: #fef9c3;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #facc15;
    }
    .bloque-dos-columnas {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .bloque-dos-columnas .item-material {
      flex: 0 0 48%;
      display: flex;
      flex-direction: column;
      margin-bottom: 14px;
    }
    .item-material label {
      font-weight: bold;
      margin-bottom: 4px;
    }
    .item-material select, .item-material input {
      margin-bottom: 4px;
    }

    @media print {
      .pdf-help,
      .pdf-btn {
        display: none;
      }
      .section,
      .bloque-dos-columnas,
      .images-grid,
      .header,
      #map,
      .images-grid img {
        page-break-inside: avoid;
        break-inside: avoid;
      }
      .ocultar-si-vacio[hidden],
      .item-material[hidden] {
        display: none !important;
      }
      @page {
        margin: 10mm 5mm;
        size: A4 portrait;
      }
    }
    .firma-row {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .firma-preview {
      width: 200px;
      height: 200px;
      border: 2px dashed #1976d2;
      background-color: #f8f9fa;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body x-data="formApp()">
  <div id="formulario">
    <div id="formulario-pdf">
      <div class="header">
        <div class="logo-wrapper" style="display: flex; flex-direction: column; align-items: flex-start;">
          <img src="logo_empresa.png" alt="Logo Empresa" class="logo" style="margin-bottom: 4px;">
          <div class="datos-empresa" style="line-height: 1.3; font-size: 13px; color: #333;">
            <p style="margin: 2px 0; font-weight: bold; color: #1565c0;">Oxbeel S.R.L Oil & Gas Solutions</p>
            <p style="margin: 2px 0;">Lago Mascardi 1499 - Parque Industrial Cipolletti, R√≠o Negro</p>
            <p style="margin: 2px 0;">üìû 0299 - 155354195</p>
          </div>
        </div>
        <div class="date-info">
          <div class="field ocultar-si-vacio" x-bind:hidden="!form.fecha">
            <i class="fa fa-calendar-alt"></i>
            <input type="date" x-model="form.fecha">
          </div>
        </div>
        <div class="logo-wrapper">
          <img src="logo_cliente.png" alt="Logo Cliente" class="logo">
        </div>
      </div>

      <!-- (Secciones del formulario: cliente, t√©cnica, actividades, mapa, im√°genes, etc) -->

      <!-- Firma del Cliente -->
      <div class="section">
        <h2><i class="fa fa-pen"></i> Firma del Cliente</h2>
        <div class="field" style="justify-content: space-between;">
          <div style="flex: 1; min-width: 200px;">
            <i class="fa fa-signature"></i>
            <label>Firma digital:</label>
            <input type="file" accept="image/*" @change="cargarFirma($event)">
          </div>
          <div style="width: 300px; height: 300px; margin-left: 20px; border: 2px dashed #1565c0; border-radius: 6px; background: #f5f7fa; display: flex; align-items: center; justify-content: center;">
            <template x-if="firmaImagen">
              <div x-html="firmaImagen"></div>
            </template>
            <template x-if="!firmaImagen">
              <span style="color:#777; font-size:14px;">A√∫n sin firma</span>
            </template>
          </div>
        </div>
      </div>

      <!-- Firma del T√©cnico Responsable -->
      <div class="section">
        <h2><i class="fa fa-pen-fancy"></i> Firma del T√©cnico Responsable</h2>
        <div class="field" style="justify-content: space-between;">
          <div style="flex: 1; min-width: 200px;">
            <i class="fa fa-signature"></i>
            <label>Firma digital:</label>
            <input type="file" accept="image/*" @change="cargarFirmaTecnico($event)">
          </div>
          <div style="width: 300px; height: 300px; margin-left: 20px; border: 2px dashed #1565c0; border-radius: 6px; background: #f5f7fa; display: flex; align-items: center; justify-content: center;">
            <template x-if="firmaTecnicoImagen">
              <div x-html="firmaTecnicoImagen"></div>
            </template>
            <template x-if="!firmaTecnicoImagen">
              <span style="color:#777; font-size:14px;">A√∫n sin firma</span>
            </template>
          </div>
        </div>
      </div>

      <div style="display: flex; flex-wrap: wrap; align-items: center;">
        <button onclick="window.print()" class="pdf-btn">
          <i class="fa fa-print"></i> Imprimir PDF
        </button>
      </div>

      <div class="pdf-help">
        üì± <strong>¬øUs√°s celular en campo?</strong> Al tocar <em>‚ÄúImprimir PDF‚Äù</em>, seleccion√° <strong>‚ÄúGuardar como PDF‚Äù</strong> si est√° disponible. Si no, us√° la opci√≥n <strong>‚ÄúCompartir‚Äù</strong> para enviarlo por WhatsApp o correo.
      </div>
    </div>
  </div>
<script>
  function formApp() {
    return {
      form: {
        nroParte: '', fecha: '', cliente: '', proyecto: '', contacto: '', locacion: '', noconvencional: '', neuquen: '',
        fusionador: '', tecnico: '', ayudante: '', supervisor: '', patente: '', horaInicio: '', horaFin: '',
        shelter: '', botella: '', tablero: '', tipoTrabajo: '', observacionesTrabajoExtra: '', materiales: [],
        tipoTrabajoExtra2: '', observacionesExtra2: '', materialesExtra2: [],
        tipoTrabajoExtra3: '', observacionesExtra3: '', materialesExtra3: [],
        firmaNombre: '', firmaID: '', ubicacion: ''
      },
      trabajos: {
        'tendido': 'Tendido de fibra √≥ptica',
        'empalpe': 'Empalme por fusi√≥n',
        'medicion': 'Medici√≥n y certificaci√≥n',
        'reparacion': 'Reparaci√≥n de cortes',
        'botella': 'Armado de botella de empalme',
        'odf': 'Armado de ODF',
        'mini_odf': 'Armado de Mini ODF'
      },
      materialesPorTrabajo: {
        'tendido': [
          { label: 'Cod 178 F.O SM 12 Hilos', opciones: null },
          { label: 'Cod 179 F.O SM 24 Hilos', opciones: null },
          { label: 'Cod 180 F.O MM 12 Hilos', opciones: null },
          { label: 'Cod 181 F.O MM 24 Hilos', opciones: null },
          { label: 'Metros Utilizados', opciones: null },
          { label: 'Tipo de Tendido', opciones: ['Canalizado', 'A√©reo'] }
        ],
        'empalpe': [
          { label: 'Cantidad de Fusiones', opciones: null },
          { label: 'Manguitos', opciones: ['Cod 169 Manguito de empalme 40 MM', 'Cod 169 Manguito de empalme 60 MM'] }
        ],
        'medicion': [
          { label: 'Tipo de Medici√≥n', opciones: ['OTDR', 'Power Meter', 'Fuente √ìptica'] },
          { label: 'Resultado', opciones: null },
          { label: 'Hora de Inicio', opciones: null },
          { label: 'Hora de Fin', opciones: null },
          { label: 'Observaciones', opciones: null }
        ],
        'reparacion': [
          { label: 'Cod 178 F.O SM 12 Hilos', opciones: null },
          { label: 'Cod 179 F.O SM 24 Hilos', opciones: null },
          { label: 'Cod 180 F.O MM 12 Hilos', opciones: null },
          { label: 'Cod 181 F.O MM 24 Hilos', opciones: null },
          { label: 'Metros Utilizados', opciones: null },
          { label: 'Tipo de Tendido', opciones: ['Canalizado', 'A√©reo'] }
        ],
        'botella': [
          { label: 'Cod 169 Manguitos de Empalme 40 MM', opciones: null },
          { label: 'Cod 169 Manguitos de Empalme 60 MM', opciones: null },
          { label: 'Cantidad de Fusiones', opciones: null }
        ],
        'odf': [
          { label: 'Cod 164 PigTail SM LC/UPC 1.5 Mtrs', opciones: null },
          { label: 'Cod 165 Pigtail SM OS2 SC/PC 2 Mtrs', opciones: null },
          { label: 'Cod 166 Pigtail SM OS2 SC/APC 2 Mtrs', opciones: null },
          { label: 'Cod 167 Pigtail SM OS2 LC 2 Mtrs', opciones: null },
          { label: 'Cod 168 Pigtail MM OM3 LC 2 Mtrs', opciones: null },
          { label: 'Cod 169 Manguito de Empalme 40 MM', opciones: null },
          { label: 'Cod 169 Manguito de Empalme 60 MM', opciones: null },
          { label: 'Cod 174 Cassette Porta Fusi√≥n 12 Fibras', opciones: null },
          { label: 'Cod 175 Cassette Porta Fusi√≥n 24 Fibras', opciones: null },
          { label: 'Cod 176 Cassette Porta Fusi√≥n 48 Fibras Stack', opciones: null },
          { label: 'Cod 163 Acopladores SM LC/UPC', opciones: null }
        ],
        'mini_odf': [
          { label: 'Cod 164 PigTail SM LC/UPC 1.5 Mtrs', opciones: null },
          { label: 'Cod 165 Pigtail SM OS2 SC/PC 2 Mtrs', opciones: null },
          { label: 'Cod 166 Pigtail SM OS2 SC/APC 2 Mtrs', opciones: null },
          { label: 'Cod 167 Pigtail SM OS2 LC 2 Mtrs', opciones: null },
          { label: 'Cod 168 Pigtail MM OM3 LC 2 Mtrs', opciones: null },
          { label: 'Cod 169 Manguito de Empalme 40 MM', opciones: null },
          { label: 'Cod 169 Manguito de Empalme 60 MM', opciones: null },
          { label: 'Cod 174 Cassette Porta Fusi√≥n 12 Fibras', opciones: null }
        ]
      },
      materialesSeleccionados: [],
      materialesExtraSeleccionados2: [],
      materialesExtraSeleccionados3: [],
      firmaImagen: '',
      firmaTecnicoImagen: '',
      mensajeImagenes: '',

      cargarFirma(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            this.firmaImagen = `<img src="${e.target.result}" style="max-width:100%; max-height:100%;">`;
          };
          reader.readAsDataURL(file);
        }
      },

      cargarFirmaTecnico(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = e => {
            this.firmaTecnicoImagen = `<img src="${e.target.result}" style="max-width:100%; max-height:100%;">`;
          };
          reader.readAsDataURL(file);
        }
      },

      mostrarVarias(event) {
        const galeria = document.getElementById('galeria');
        galeria.innerHTML = '';
        Array.from(event.target.files).forEach(file => {
          const reader = new FileReader();
          reader.onload = e => {
            const img = document.createElement('img');
            img.src = e.target.result;
            galeria.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      },

      cargarMateriales() {
        const lista = this.materialesPorTrabajo[this.form.tipoTrabajo] || [];
        this.materialesSeleccionados = lista;
        this.form.materiales = lista.map(() => ({ cantidad: '', obs: '', opcion: '' }));
      },

      cargarMaterialesExtra2() {
        const lista = this.materialesPorTrabajo[this.form.tipoTrabajoExtra2] || [];
        this.materialesExtraSeleccionados2 = lista;
        this.form.materialesExtra2 = lista.map(() => ({ cantidad: '', obs: '', opcion: '' }));
      },

      cargarMaterialesExtra3() {
        const lista = this.materialesPorTrabajo[this.form.tipoTrabajoExtra3] || [];
        this.materialesExtraSeleccionados3 = lista;
        this.form.materialesExtra3 = lista.map(() => ({ cantidad: '', obs: '', opcion: '' }));
      },

      enviarDatos() {
        fetch("https://script.google.com/macros/s/AKfycbzSgJIelKuF3UNbIW6opyJOm6gJkBnCaOOfy28qaR5AYsVUSON8w1hGiUJsnRNGZIyz3w/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(this.form)
        })
        .then(res => res.text())
        .then(txt => {
          alert("‚úÖ Parte diario guardado en Google Sheets correctamente");
        })
        .catch(err => {
          alert("‚ö†Ô∏è Error al guardar: " + err.message);
        });
      },

      inicializarMapa() {
        if (!navigator.geolocation) {
          alert("Geolocalizaci√≥n no soportada por este navegador.");
          return;
        }
        navigator.geolocation.getCurrentPosition(pos => {
          const { latitude, longitude } = pos.coords;
          this.form.ubicacion = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
          const map = L.map('map').setView([latitude, longitude], 15);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '¬© OpenStreetMap'
          }).addTo(map);
          L.marker([latitude, longitude]).addTo(map).bindPopup("Ubicaci√≥n actual").openPopup();
        }, err => {
          alert("Error al obtener ubicaci√≥n: " + err.message);
        });
      }
    };
  }
</script>
</body>
</html>
